// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"] // OK for Render's Linux images
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ============================
   Enums
   ============================ */

enum Role {
  ADMIN
  COORDINATOR
  TA
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACTIVE
  REVOKED
}

enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

/* ============================
   Core Models
   ============================ */

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Back relations ---
  applications  Application[]
  timesheets    Timesheet[]    @relation("UserTimesheets")
  assignments   Assignment[]   @relation("UserAssignments")
  logs          AuditLog[]
  notifications Notification[]
  teachingAssistant TeachingAssistant?

  @@index([email])
}

model Course {
  id        String   @id @default(cuid())
  code      String
  title     String
  term      String
  capacity  Int      @default(3)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Course relationships
  assignments  Assignment[]
  applications Application[]

  @@index([code, term])
}

model TeachingAssistant {
  id        String   @id @default(cuid())
  userId    String   @unique
  hours     Int      @default(20)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // link to the owning user (usually role TA)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/* ============================
   Relational Children
   ============================ */

/* Fix 1: Timesheet has FK -> User with clear opposite side on User.timesheets */
model Timesheet {
  id        String          @id @default(cuid())
  userId    String
  weekStart DateTime
  hours     Int             @default(0)
  status    TimesheetStatus @default(PENDING)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user User @relation("UserTimesheets", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/* Fix 2: Assignment has FK -> User with clear opposite side on User.assignments */
model Assignment {
  id        String            @id @default(cuid())
  userId    String
  courseId  String
  status    AssignmentStatus  @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user   User   @relation("UserAssignments", fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

/* ============================
   Supporting Models
   ============================ */

model Application {
  id        String             @id @default(cuid())
  userId    String
  courseId  String
  statement String?
  status    ApplicationStatus  @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
